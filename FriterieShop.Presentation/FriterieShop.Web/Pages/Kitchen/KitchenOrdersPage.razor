@page "/kitchen"
@layout KitchenLayout

<section class="mx-auto max-w-full px-4 sm:px-6 lg:px-8 mt-6 mb-12">
  <header class="flex items-center justify-between mb-4">
    <h2 class="text-2xl font-bold">Commandes Cuisine</h2>
    <button class="inline-flex items-center rounded bg-neutral-900 text-white px-3 py-1 text-sm font-semibold hover:bg-neutral-800" @onclick="ReloadAsync">Rafra&icirc;chir</button>
  </header>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4" style="min-height:75vh">

    @* ── Colonne 1 : En attente ── *@
    <div class="@ColumnCss(ColPending, "orange")"
         @ondragover="OnDragOver" @ondragover:preventDefault
         @ondragenter="() => OnDragEnter(ColPending)"
         @ondragleave="OnDragLeaveHandler"
         @ondrop="() => OnDrop(ColPending)" @ondrop:preventDefault>
      <div class="sticky top-0 z-10 flex items-center justify-between px-4 py-3 bg-orange-100 rounded-t-xl border-b border-orange-300">
        <h3 class="font-bold text-orange-800">En attente</h3>
        <span class="rounded-full bg-orange-200 text-orange-900 px-2.5 py-0.5 text-xs font-bold">@PendingOrders.Count()</span>
      </div>
      <div class="flex-1 overflow-y-auto p-3 space-y-3">
        @if (PendingOrders.Any())
        {
          @foreach (var o in PendingOrders.OrderByDescending(x => x.CreatedOn))
          {
            <div draggable="true"
                 class="@CardCss(o.Id, "orange")"
                 @ondragstart="() => OnDragStart(o)"
                 @ondragend="OnDragEnd">
              @RenderCardContent(o)
            </div>
          }
        }
        else
        {
          <div class="text-center text-sm text-orange-400 py-8">Aucune commande</div>
        }
      </div>
    </div>

    @* ── Colonne 2 : En cours ── *@
    <div class="@ColumnCss(ColInProgress, "blue")"
         @ondragover="OnDragOver" @ondragover:preventDefault
         @ondragenter="() => OnDragEnter(ColInProgress)"
         @ondragleave="OnDragLeaveHandler"
         @ondrop="() => OnDrop(ColInProgress)" @ondrop:preventDefault>
      <div class="sticky top-0 z-10 flex items-center justify-between px-4 py-3 bg-blue-100 rounded-t-xl border-b border-blue-300">
        <h3 class="font-bold text-blue-800">En cours</h3>
        <span class="rounded-full bg-blue-200 text-blue-900 px-2.5 py-0.5 text-xs font-bold">@InProgressOrders.Count()</span>
      </div>
      <div class="flex-1 overflow-y-auto p-3 space-y-3">
        @if (InProgressOrders.Any())
        {
          @foreach (var o in InProgressOrders.OrderByDescending(x => x.CreatedOn))
          {
            <div draggable="true"
                 class="@CardCss(o.Id, "blue")"
                 @ondragstart="() => OnDragStart(o)"
                 @ondragend="OnDragEnd">
              @RenderCardContent(o)
            </div>
          }
        }
        else
        {
          <div class="text-center text-sm text-blue-400 py-8">Aucune commande</div>
        }
      </div>
    </div>

    @* ── Colonne 3 : Terminé ── *@
    <div class="@ColumnCss(ColDelivered, "green")"
         @ondragover="OnDragOver" @ondragover:preventDefault
         @ondragenter="() => OnDragEnter(ColDelivered)"
         @ondragleave="OnDragLeaveHandler"
         @ondrop="() => OnDrop(ColDelivered)" @ondrop:preventDefault>
      <div class="sticky top-0 z-10 flex items-center justify-between px-4 py-3 bg-green-100 rounded-t-xl border-b border-green-300">
        <h3 class="font-bold text-green-800">Termin&eacute;</h3>
        <span class="rounded-full bg-green-200 text-green-900 px-2.5 py-0.5 text-xs font-bold">@DeliveredOrders.Count()</span>
      </div>
      <div class="flex-1 overflow-y-auto p-3 space-y-3">
        @if (DeliveredOrders.Any())
        {
          @foreach (var o in DeliveredOrders.OrderByDescending(x => x.CreatedOn))
          {
            <div draggable="true"
                 class="@CardCss(o.Id, "green")"
                 @ondragstart="() => OnDragStart(o)"
                 @ondragend="OnDragEnd">
              @RenderCardContent(o)
            </div>
          }
        }
        else
        {
          <div class="text-center text-sm text-green-400 py-8">Aucune commande</div>
        }
      </div>
    </div>

  </div>
</section>

@implements IDisposable

@code {
  private List<GetOrder> _orders = new();
  private CancellationTokenSource _cts = new();
  private const int PollIntervalSeconds = 15;

  // Column identifiers
  private const string ColPending = "PendingShipment";
  private const string ColInProgress = "InProgress";
  private const string ColDelivered = "Delivered";

  // Drag & drop state
  private Guid? _draggedOrderId;
  private string? _dragOverColumn;

  private IEnumerable<GetOrder> PendingOrders => _orders.Where(o => o.ShippingStatus == "PendingShipment");
  private IEnumerable<GetOrder> InProgressOrders => _orders.Where(o => o.ShippingStatus is "Shipped" or "InTransit" or "OutForDelivery");
  private IEnumerable<GetOrder> DeliveredOrders => _orders.Where(o => o.ShippingStatus == "Delivered");

  protected override async Task OnInitializedAsync()
  {
    await ReloadAsync();
    _ = PollOrdersAsync();
  }

  private async Task PollOrdersAsync()
  {
    var timer = new PeriodicTimer(TimeSpan.FromSeconds(PollIntervalSeconds));
    try
    {
      while (await timer.WaitForNextTickAsync(_cts.Token))
      {
        await ReloadAsync();
        await InvokeAsync(StateHasChanged);
      }
    }
    catch (OperationCanceledException) { }
  }

  private async Task ReloadAsync()
  {
    var client = await HttpClientHelper.GetPrivateClientAsync();
    var api = new ApiCall { Client = client, Route = Constant.Cart.GetAllOrders, Type = Constant.ApiCallType.Get };
    var http = await ApiCallHelper.ApiCallTypeCall<object>(api);
    _orders = http is null || !http.IsSuccessStatusCode
        ? new()
        : (await ApiCallHelper.GetServiceResponse<IEnumerable<GetOrder>>(http)).ToList();
  }

  // ── Drag & Drop ──

  private void OnDragStart(GetOrder order)
  {
    _draggedOrderId = order.Id;
  }

  private void OnDragEnd()
  {
    _draggedOrderId = null;
    _dragOverColumn = null;
  }

  private void OnDragOver(DragEventArgs e) { }

  private void OnDragEnter(string column)
  {
    if (_draggedOrderId.HasValue)
      _dragOverColumn = column;
  }

  private void OnDragLeaveHandler(DragEventArgs e)
  {
    _dragOverColumn = null;
  }

  private async Task OnDrop(string targetColumn)
  {
    _dragOverColumn = null;

    if (_draggedOrderId is null) return;

    var order = _orders.FirstOrDefault(o => o.Id == _draggedOrderId.Value);
    _draggedOrderId = null;
    if (order is null) return;

    var newStatus = targetColumn switch
    {
      ColPending => "PendingShipment",
      ColInProgress => "Shipped",
      ColDelivered => "Delivered",
      _ => null
    };

    if (newStatus is null || order.ShippingStatus == newStatus) return;

    // Optimistic UI update
    order.ShippingStatus = newStatus;
    StateHasChanged();

    // Call API
    try
    {
      var client = await HttpClientHelper.GetPrivateClientAsync();
      var route = $"{Constant.Cart.UpdateShippingStatus}/{order.Id}/shipping-status";
      var body = new { shippingStatus = newStatus, shippedOn = (DateTime?)null, deliveredOn = newStatus == "Delivered" ? DateTime.UtcNow : (DateTime?)null };
      var api = new ApiCall { Client = client, Route = route, Type = Constant.ApiCallType.Update, Model = body };
      await ApiCallHelper.ApiCallTypeCall<object>(api);
    }
    catch
    {
      await ReloadAsync();
    }

    StateHasChanged();
  }

  public void Dispose()
  {
    _cts.Cancel();
    _cts.Dispose();
  }

  // ── CSS helpers ──

  private string ColumnCss(string column, string color)
  {
    var highlight = _dragOverColumn == column;
    var (borderNormal, borderHighlight, bgNormal, bgHighlight) = color switch
    {
      "orange" => ("border-orange-300", "border-orange-500", "bg-orange-50/60", "bg-orange-100/80"),
      "blue" => ("border-blue-300", "border-blue-500", "bg-blue-50/60", "bg-blue-100/80"),
      "green" => ("border-green-300", "border-green-500", "bg-green-50/60", "bg-green-100/80"),
      _ => ("border-neutral-300", "border-neutral-500", "bg-neutral-50/60", "bg-neutral-100/80")
    };
    var border = highlight ? borderHighlight : borderNormal;
    var bg = highlight ? bgHighlight : bgNormal;
    return $"flex flex-col rounded-xl border-2 {border} {bg} transition-colors duration-150";
  }

  private string CardCss(Guid orderId, string color)
  {
    var dragging = _draggedOrderId == orderId;
    var borderCss = color switch
    {
      "orange" => "border-orange-300",
      "blue" => "border-blue-300",
      "green" => "border-green-300",
      _ => "border-neutral-300"
    };
    var opacity = dragging ? " opacity-40" : "";
    return $"cursor-grab active:cursor-grabbing rounded-lg border {borderCss} bg-white shadow-sm{opacity}";
  }

  // ── Card rendering ──

  private static RenderFragment RenderCardContent(GetOrder o) => __builder =>
  {
    <div class="px-3 py-2 flex items-center justify-between">
      <span class="font-mono font-bold text-sm">@o.Reference</span>
      @{ var badge = GetBadge(o.ShippingStatus); }
      <span class="rounded-full px-2 py-0.5 text-[10px] font-bold @badge.Css">@badge.Label</span>
    </div>
    <div class="px-3 pb-1 text-xs text-neutral-500">
      @(o.CustomerName ?? o.CustomerEmail ?? "(Inconnu)") &mdash; @o.CreatedOn.ToLocalTime().ToString("dd/MM HH:mm")
    </div>
    <div class="px-3 pb-3">
      <ul class="divide-y divide-neutral-100 text-xs">
        @foreach (var l in o.Lines)
        {
          <li class="flex items-center justify-between py-1">
            <span class="truncate mr-2" title="@l.ProductName">@l.ProductName</span>
            <span class="shrink-0 font-semibold">@($"x{l.Quantity}")</span>
          </li>
        }
      </ul>
      <div class="mt-1.5 text-right text-xs font-bold">&euro; @o.TotalAmount.ToString("F2")</div>
    </div>
  };

  private record BadgeInfo(string Label, string Css);

  private static BadgeInfo GetBadge(string status) => status switch
  {
    "PendingShipment" => new("En attente", "bg-orange-100 text-orange-800"),
    "Shipped" => new("Exp\u00e9di\u00e9", "bg-blue-100 text-blue-800"),
    "InTransit" => new("En transit", "bg-indigo-100 text-indigo-800"),
    "OutForDelivery" => new("En livraison", "bg-purple-100 text-purple-800"),
    "Delivered" => new("Termin\u00e9", "bg-green-100 text-green-800"),
    _ => new(status, "bg-neutral-100 text-neutral-800")
  };
}
